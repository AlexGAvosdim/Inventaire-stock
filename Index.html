<!DOCTYPE html>
<html lang="fr" class="light">
<head>
    <meta charset="UTF-8">
    <title>Gestionnaire Supply-Chain</title>
    <!-- Librairies externes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Config Tailwind -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        indigo: { 600: '#4F46E5', 700: '#4338CA' },
                        gray: { 50: '#F9FAFB', 100: '#F3F4F6', 700: '#374151', 800: '#1F2937', 900: '#111827' },
                        franklin: '#FE9A37', george: '#2B7FFF', abraham: '#FFD230'
                    },
                    animation: { 'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                }
            }
        }
    </script>

    <!-- STYLE -->
    <?!= include('Style'); ?>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen font-sans transition-colors duration-200">

    <!-- BANNIERE ERREUR -->
    <div id="js-error-banner" class="hidden fixed top-0 left-0 w-full bg-red-600 text-white p-4 z-[100] shadow-xl">
        <div class="flex items-center justify-between max-w-4xl mx-auto">
            <div class="flex items-center"><i data-lucide="alert-octagon" class="w-6 h-6 mr-3"></i><span id="js-error-text" class="font-mono text-sm">Erreur Critique</span></div>
            <button onclick="document.getElementById('js-error-banner').classList.add('hidden')" class="bg-red-800 px-3 py-1 rounded text-xs hover:bg-red-700">Fermer</button>
        </div>
    </div>

    <!-- ECRAN DE CONNEXION -->
    <div id="loginView" class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="max-w-md w-full bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 space-y-8">
            <div class="text-center">
                <div class="mb-6 flex flex-col items-center justify-center">
                    <!-- LOGO BOITE -->
                    <div class="h-16 w-16 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center mb-3">
                        <i data-lucide="package" class="h-10 w-10 text-indigo-600"></i>
                    </div>
                    <h1 class="text-3xl font-black text-indigo-600 dark:text-indigo-400 tracking-tighter brand-logo">AVOSDIM</h1>
                    <p class="text-sm text-gray-500 font-medium uppercase tracking-widest mt-1">Gestionnaire Supply-Chain</p>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Opérateur</label>
                <select id="loginUserSelect" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-lg focus:ring-2 focus:ring-indigo-500">
                    <option value="">Chargement...</option>
                </select>
            </div>
            <div class="flex justify-center space-x-6 mb-4">
                <div class="pin-dot" id="dot-1"></div><div class="pin-dot" id="dot-2"></div><div class="pin-dot" id="dot-3"></div><div class="pin-dot" id="dot-4"></div>
            </div>
            <div class="grid grid-cols-3 gap-4 max-w-[280px] mx-auto">
                <button class="pin-btn" onclick="enterPin('1')">1</button><button class="pin-btn" onclick="enterPin('2')">2</button><button class="pin-btn" onclick="enterPin('3')">3</button>
                <button class="pin-btn" onclick="enterPin('4')">4</button><button class="pin-btn" onclick="enterPin('5')">5</button><button class="pin-btn" onclick="enterPin('6')">6</button>
                <button class="pin-btn" onclick="enterPin('7')">7</button><button class="pin-btn" onclick="enterPin('8')">8</button><button class="pin-btn" onclick="enterPin('9')">9</button>
                <button class="w-16 h-16 rounded-full text-xl font-bold text-red-500 bg-red-50 hover:bg-red-100 flex items-center justify-center" onclick="clearPin()"><i data-lucide="delete" class="w-6 h-6"></i></button>
                <button class="pin-btn" onclick="enterPin('0')">0</button>
                <button class="w-16 h-16 rounded-full text-xl font-bold text-indigo-600 bg-indigo-50 hover:bg-indigo-100 flex items-center justify-center" onclick="submitLogin()"><i data-lucide="arrow-right" class="w-6 h-6"></i></button>
            </div>
            <div id="loginError" class="text-center text-red-500 text-sm font-bold h-5"></div>
        </div>
    </div>

    <!-- APPLICATION PRINCIPALE -->
    <div id="appView" class="hidden">
        <header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-50">
            <div class="w-full px-4 h-16 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="flex items-center bg-indigo-50 dark:bg-indigo-900/20 px-2 py-1 rounded-lg">
                        <i data-lucide="package" class="h-6 w-6 text-indigo-600 mr-2"></i>
                        <span class="text-xl font-black text-indigo-700 dark:text-indigo-400 tracking-tighter brand-logo">AVOSDIM</span>
                    </div>
                    <div class="h-6 w-px bg-gray-300 dark:bg-gray-600 mx-2"></div>
                    <h1 class="text-lg font-bold hidden sm:block text-gray-700 dark:text-gray-200">Gestionnaire Supply-Chain</h1>
                </div>
                <nav class="flex space-x-2">
                    <div id="menu-admin" class="flex space-x-2 hidden">
                        <button onclick="showView('home')" id="nav-home" class="px-3 py-2 rounded-md text-sm font-medium text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700">Import CSV</button>
                        <button onclick="showView('database')" id="nav-db" class="px-3 py-2 rounded-md text-sm font-medium text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700">BDD</button>
                        <button onclick="showView('validation')" id="nav-val" class="px-3 py-2 rounded-md text-sm font-medium text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700">Inv. Tournant</button>
                        <button onclick="showView('settings')" id="nav-set" class="px-3 py-2 rounded-md text-sm font-medium text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center"><i data-lucide="settings" class="h-4 w-4 mr-1"></i> Config</button>
                    </div>
                    <button onclick="showView('operator')" id="nav-audit" class="px-3 py-2 rounded-md text-sm font-medium text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center"><i data-lucide="clipboard-list" class="h-4 w-4 mr-1"></i> Audit</button>
                </nav>
                <div class="flex items-center space-x-3">
                    <div class="text-right">
                        <p class="text-base font-bold" id="userDisplayName">User</p>
                        <p class="text-xs text-gray-500 uppercase" id="userRoleDisplay">Role</p>
                    </div>
                    <button onclick="toggleTheme()" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700" title="Thème"><i id="theme-icon" data-lucide="moon" class="h-5 w-5"></i></button>
                    <button onclick="logout()" class="p-2 rounded-full text-red-500 hover:bg-red-50 dark:hover:bg-gray-700"><i data-lucide="log-out" class="h-5 w-5"></i></button>
                </div>
            </div>
        </header>

        <main class="w-[98%] mx-auto py-6 space-y-6">
            
            <!-- VUE 1 : OPERATEUR -->
            <div id="operatorArea" class="hidden space-y-6 fade-in">
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <div>
                        <h2 class="text-lg font-bold flex items-center"><i data-lucide="list-todo" class="h-5 w-5 mr-2 text-indigo-600"></i>Inventaires à faire</h2>
                        <p class="text-sm text-gray-500 dark:text-gray-400" id="queueInfo"></p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openSpotCheckModal()" class="p-3 bg-indigo-100 hover:bg-indigo-200 dark:bg-indigo-900/50 dark:hover:bg-indigo-900 rounded-full text-indigo-700 dark:text-indigo-300" title="Recherche / Ajout Spontané"><i data-lucide="search" class="h-6 w-6"></i></button>
                        <button onclick="loadOperatorTasks()" class="p-3 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-full"><i data-lucide="refresh-cw" class="h-6 w-6 text-gray-600 dark:text-gray-200"></i></button>
                    </div>
                </div>
                <div id="taskList" class="space-y-4"></div>
                <div id="emptyState" class="hidden text-center py-10"><h3 class="text-lg font-medium dark:text-white">Tout est à jour !</h3></div>
            </div>

            <!-- VUE 2 : ADMIN VALIDATION -->
            <div id="adminValidationArea" class="hidden space-y-6 fade-in">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold flex items-center">
                            <i data-lucide="check-circle" class="h-6 w-6 mr-2 text-indigo-600"></i>
                            Inventaire Tournant
                            <div class="ml-3 flex items-center opacity-0 transition-opacity duration-500" id="live-sync-indicator" title="Synchronisation active">
                                <span class="relative flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span></span>
                            </div>
                        </h2>
                        <div class="flex items-center gap-2">
                             <span id="last-update-time" class="text-xs text-gray-400"></span>
                             <button onclick="refreshCurrentTab()" class="text-sm text-gray-500 hover:text-indigo-600 dark:text-gray-400 dark:hover:text-indigo-400"><i data-lucide="refresh-cw" class="h-4 w-4"></i></button>
                        </div>
                    </div>
                    <div class="flex border-b border-gray-200 dark:border-gray-700 mb-6">
                        <button onclick="switchInvTab('validation')" id="tab-btn-validation" class="tab-btn active">Validation</button>
                        <button onclick="switchInvTab('encours')" id="tab-btn-encours" class="tab-btn">En Cours / Listes</button>
                        <button onclick="switchInvTab('history')" id="tab-btn-history" class="tab-btn">Historique</button>
                    </div>
                    <!-- TAB 1: VALIDATION -->
                    <div id="tab-content-validation" class="block">
                        <div class="mb-4 flex space-x-2">
                            <button onclick="validateConforme()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md text-sm font-medium flex items-center shadow"><i data-lucide="check-check" class="h-4 w-4 mr-2"></i> Valider conformes</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm divide-y divide-gray-200 dark:divide-gray-700"><thead class="bg-gray-50 dark:bg-gray-700"><tr><th class="px-4 py-3 text-left w-2/3">Article / Zone</th><th class="px-4 py-3 text-center w-1/6">Données</th><th class="px-4 py-3 text-right w-1/6">Actions</th></tr></thead><tbody id="validationTableBody" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody></table>
                        </div>
                    </div>
                    <!-- TAB 2: EN COURS -->
                    <div id="tab-content-encours" class="hidden">
                         <div class="mb-4 flex space-x-2 justify-between items-center">
                            <div class="text-sm text-gray-500">Liste des comptages en attente ou assignés.</div>
                            <div class="flex gap-2">
                                <button onclick="openAddArticleModal()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md text-sm font-medium flex items-center shadow"><i data-lucide="plus" class="h-4 w-4 mr-2"></i> Ajouter Article</button>
                                <button onclick="openResetModal()" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md text-xs font-bold" title="Régénérer la liste"><i data-lucide="refresh-ccw" class="w-3 h-3 mr-1 inline"></i>Reset & Générer</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm divide-y divide-gray-200 dark:divide-gray-700"><thead class="bg-gray-50 dark:bg-gray-700"><tr><th class="px-3 py-3 text-left">Article</th><th class="px-3 py-3 text-left">Emplacement</th><th class="px-3 py-3 text-center">Statut / Assigné</th><th class="px-3 py-3 text-right">Actions</th></tr></thead><tbody id="todoTableBody" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody></table>
                        </div>
                    </div>
                    <!-- TAB 3: HISTORY -->
                    <div id="tab-content-history" class="hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm divide-y divide-gray-200 dark:divide-gray-700"><thead class="bg-gray-50 dark:bg-gray-700"><tr><th class="px-3 py-3 text-left">Date</th><th class="px-3 py-3 text-left">Opérateur</th><th class="px-3 py-3 text-left">Emplacement</th><th class="px-3 py-3 text-left">Article</th><th class="px-3 py-3 text-center">Ecart</th></tr></thead><tbody id="historyTableBody" class="divide-y divide-gray-200 dark:divide-gray-700 text-sm"></tbody></table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- VUE 3 : BDD COMPLETE -->
            <div id="databaseArea" class="hidden">
                <div class="bg-white dark:bg-gray-800 p-4 rounded shadow-lg h-[85vh] flex flex-col">
                    <div class="flex justify-between items-center mb-4 shrink-0">
                        <div class="flex items-center gap-4">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
                                <i data-lucide="database" class="w-6 h-6 mr-2 text-indigo-600"></i>
                                Base de données
                            </h2>
                            <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full font-medium hidden" id="badge-active-count">Actifs: 0</span>
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full font-medium hidden" id="badge-last-import">Import: -</span>
                        </div>
                        <div class="flex space-x-2">
                            <input type="text" id="dbSearch" placeholder="Chercher ref/nom..." onkeyup="filterDb()" class="border p-1 rounded text-sm w-64 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <button onclick="forceReloadDb()" class="btn-std btn-action"><i data-lucide="refresh-cw" class="w-3 h-3 mr-1"></i> Force Reload</button>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-3 mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded border border-gray-200 dark:border-gray-600 items-center">
                        <div class="flex items-center gap-1">
                            <span class="text-xs font-bold text-gray-500 dark:text-gray-300 mr-1 uppercase">Statut :</span>
                            <button onclick="toggleStatusFilter('Actif')" class="btn-std active" id="btn-filter-actif">Actifs</button>
                            <button onclick="toggleStatusFilter('Inactif')" class="btn-std inactive" id="btn-filter-inactif">Inactifs</button>
                        </div>
                        <div class="w-px h-5 bg-gray-300 dark:bg-gray-500 mx-2"></div>
                        <div class="flex items-center gap-1">
                            <span class="text-xs font-bold text-gray-500 dark:text-gray-300 mr-1 uppercase">Afficher :</span>
                            <button onclick="toggleColumnGroup('col-f')" class="btn-std inactive" id="btn-col-f">Franklin</button>
                            <button onclick="toggleColumnGroup('col-g')" class="btn-std inactive" id="btn-col-g">Georges</button>
                            <button onclick="toggleColumnGroup('col-a')" class="btn-std inactive" id="btn-col-a">Abraham</button>
                            <button onclick="toggleColumnGroup('col-tech')" class="btn-std inactive" id="btn-col-tech">Dims/Poids</button>
                        </div>
                    </div>
                    <div class="overflow-auto flex-1 border rounded bg-white dark:bg-gray-900 dark:border-gray-700 relative">
                        <table class="min-w-full text-xs divide-y divide-gray-200 dark:divide-gray-700 table-compact">
                            <thead class="bg-gray-100 dark:bg-gray-700 sticky-header">
                                <tr>
                                    <th class="text-left font-bold w-16">Statut</th>
                                    <th class="text-left font-bold w-16">Tags</th>
                                    <th class="text-left font-bold w-24">Ref</th>
                                    <th class="text-left font-bold w-64">Nom</th>
                                    <th class="text-left font-bold w-32">Fournisseur</th>
                                    
                                    <th class="col-f hidden-col text-center font-bold text-f bg-f-soft border-l border-f">F-Rack</th>
                                    <th class="col-f hidden-col text-center font-bold text-f bg-f-soft">F-Row</th>
                                    <th class="col-f hidden-col text-center font-bold text-f bg-f-soft">F-Case</th>
                                    <th class="col-f hidden-col text-center font-bold text-f bg-f-soft">F-Sur</th>
                                    
                                    <th class="col-g hidden-col text-center font-bold text-g bg-g-soft border-l border-g">G-Rack</th>
                                    <th class="col-g hidden-col text-center font-bold text-g bg-g-soft">G-Row</th>
                                    <th class="col-g hidden-col text-center font-bold text-g bg-g-soft">G-Case</th>
                                    <th class="col-g hidden-col text-center font-bold text-g bg-g-soft">G-Sur</th>
                                    
                                    <th class="col-a hidden-col text-center font-bold text-a bg-a-soft border-l border-a">A-Rack</th>
                                    <th class="col-a hidden-col text-center font-bold text-a bg-a-soft">A-Row</th>
                                    <th class="col-a hidden-col text-center font-bold text-a bg-a-soft">A-Case</th>
                                    <th class="col-a hidden-col text-center font-bold text-a bg-a-soft">A-Sur</th>
                                    
                                    <th class="col-tech hidden-col text-center border-l">Cote 1</th>
                                    <th class="col-tech hidden-col text-center">Cote 2</th>
                                    <th class="col-tech hidden-col text-center">Cote 3</th>
                                    <th class="col-tech hidden-col text-center">Poids</th>
                                    
                                    <th class="text-right font-bold border-l">Stock</th>
                                    <th class="text-right border-l">Ajouté</th>
                                    <th class="text-right">Modifié</th>
                                    <th class="text-right">Vu le</th>
                                    <th class="text-right text-indigo-600 font-medium">Inv. le</th>
                                    <th class="col-del hidden-col text-right text-red-600 border-l">Supprimé</th>
                                </tr>
                            </thead>
                            <tbody id="dbTableBody" class="divide-y divide-gray-100 dark:divide-gray-700"></tbody>
                        </table>
                        <div id="dbLoader" class="hidden absolute inset-0 bg-white/80 dark:bg-gray-900/80 flex items-center justify-center"><div class="loader"></div></div>
                        <div id="dbSentinel" class="h-4 w-full"></div>
                    </div>
                    <div class="text-xs text-gray-400 mt-1 flex justify-between"><span>Double-cliquez sur "Tag" pour modifier.</span><span id="dbCountDisplay">0 articles affichés</span></div>
                </div>
            </div>

            <!-- VUE PARAMETRES, IMPORT (Contenu préservé, styles globaux appliqués) -->
            <div id="settingsArea" class="hidden space-y-6 fade-in">...</div>
            <div id="homeArea" class="hidden">...</div>
        </main>
    </div>

    <!-- MODALES (Ajout manuel, Reset, etc. - Code préservé) -->
    <div id="modalAddManual" class="hidden">...</div>
    <div id="modalConfirmTrigger" class="hidden">...</div>
    <div id="modalResetGenerate" class="hidden">...</div>
    <div id="modalSpotCheck" class="hidden">...</div>
    <div id="modalArticleHistory" class="hidden">...</div>

    <!-- NOUVELLE MODALE EDIT TAG (v7.2.0) -->
    <div id="modalEditTag" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center z-[95]">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-80">
            <h3 class="text-lg font-bold mb-4 dark:text-white flex items-center"><i data-lucide="tag" class="w-5 h-5 mr-2 text-indigo-600"></i> Modifier Tag</h3>
            <div class="bg-gray-50 dark:bg-gray-700 p-2 rounded mb-4 text-sm font-mono font-bold text-center" id="tagModalRef">REF</div>
            <label class="block text-xs font-bold mb-1 dark:text-gray-300">Tag actuel</label>
            <input type="text" id="tagModalInput" class="w-full p-2 border rounded mb-4 dark:bg-gray-600 dark:text-white">
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('modalEditTag').classList.add('hidden')" class="px-3 py-2 text-gray-500 hover:bg-gray-100 rounded text-sm">Annuler</button>
                <button onclick="confirmEditTag()" class="px-3 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm font-bold">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- INCLUSION LOGIQUE JAVASCRIPT -->
    <?!= include('JS_Core'); ?>
    <?!= include('JS_App'); ?>
    <?!= include('JS_Settings'); ?>
</body>
</html>
