<!DOCTYPE html>
<html lang="fr" class="light">
<head>
    <meta charset="UTF-8">
    <title>Avosdim - Gestion Stock v7.1.0</title>
    <!-- Librairies externes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Config Tailwind -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        indigo: { 600: '#4F46E5', 700: '#4338CA' },
                        gray: { 50: '#F9FAFB', 100: '#F3F4F6', 700: '#374151', 800: '#1F2937', 900: '#111827' },
                        franklin: '#FE9A37', george: '#2B7FFF', abraham: '#FFD230'
                    },
                    animation: { 'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                }
            }
        }
    </script>

    <!-- STYLE -->
    <?!= include('Style'); ?>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen font-sans transition-colors duration-200">

    <!-- BANNIERE ERREUR -->
    <div id="js-error-banner" class="hidden fixed top-0 left-0 w-full bg-red-600 text-white p-4 z-[100] shadow-xl">
        <div class="flex items-center justify-between max-w-4xl mx-auto">
            <div class="flex items-center"><i data-lucide="alert-octagon" class="w-6 h-6 mr-3"></i><span id="js-error-text" class="font-mono text-sm">Erreur Critique</span></div>
            <button onclick="document.getElementById('js-error-banner').classList.add('hidden')" class="bg-red-800 px-3 py-1 rounded text-xs hover:bg-red-700">Fermer</button>
        </div>
    </div>

    <!-- ECRAN DE CONNEXION -->
    <div id="loginView" class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="max-w-md w-full bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 space-y-8">
            <div class="text-center">
                <div class="mb-6 flex flex-col items-center justify-center">
                    <div class="h-16 w-16 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center mb-3"><i data-lucide="shield-check" class="h-8 w-8 text-indigo-600"></i></div>
                    <h1 class="text-3xl font-black text-indigo-600 dark:text-indigo-400 tracking-tighter brand-logo">AVOSDIM</h1>
                    <p class="text-sm text-gray-500 font-medium uppercase tracking-widest mt-1">Gestionnaire Supply Chain</p>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Opérateur</label>
                <select id="loginUserSelect" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-lg focus:ring-2 focus:ring-indigo-500">
                    <option value="">Chargement...</option>
                </select>
            </div>
            <div class="flex justify-center space-x-6 mb-4">
                <div class="pin-dot" id="dot-1"></div><div class="pin-dot" id="dot-2"></div><div class="pin-dot" id="dot-3"></div><div class="pin-dot" id="dot-4"></div>
            </div>
            <div class="grid grid-cols-3 gap-4 max-w-[280px] mx-auto">
                <button class="pin-btn" onclick="enterPin('1')">1</button><button class="pin-btn" onclick="enterPin('2')">2</button><button class="pin-btn" onclick="enterPin('3')">3</button>
                <button class="pin-btn" onclick="enterPin('4')">4</button><button class="pin-btn" onclick="enterPin('5')">5</button><button class="pin-btn" onclick="enterPin('6')">6</button>
                <button class="pin-btn" onclick="enterPin('7')">7</button><button class="pin-btn" onclick="enterPin('8')">8</button><button class="pin-btn" onclick="enterPin('9')">9</button>
                <button class="w-16 h-16 rounded-full text-xl font-bold text-red-500 bg-red-50 hover:bg-red-100 flex items-center justify-center" onclick="clearPin()"><i data-lucide="delete" class="w-6 h-6"></i></button>
                <button class="pin-btn" onclick="enterPin('0')">0</button>
                <button class="w-16 h-16 rounded-full text-xl font-bold text-indigo-600 bg-indigo-50 hover:bg-indigo-100 flex items-center justify-center" onclick="submitLogin()"><i data-lucide="arrow-right" class="w-6 h-6"></i></button>
            </div>
            <div id="loginError" class="text-center text-red-500 text-sm font-bold h-5"></div>
        </div>
    </div>

    <!-- APPLICATION PRINCIPALE -->
    <div id="appView" class="hidden">
        <header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-50">
            <div class="w-full px-4 h-16 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="flex items-center bg-indigo-50 dark:bg-indigo-900/20 px-2 py-1 rounded-lg">
                        <i data-lucide="box" class="h-6 w-6 text-indigo-600 mr-2"></i>
                        <span class="text-xl font-black text-indigo-700 dark:text-indigo-400 tracking-tighter brand-logo">AVOSDIM</span>
                    </div>
                    <div class="h-6 w-px bg-gray-300 dark:bg-gray-600 mx-2"></div>
                    <h1 class="text-lg font-bold hidden sm:block text-gray-700 dark:text-gray-200">Gestionnaire Supply Chain <span class="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full ml-1 font-normal">v7.1.0</span></h1>
                </div>
                <nav class="flex space-x-2">
                    <div id="menu-admin" class="flex space-x-2 hidden">
                        <button onclick="showView('home')" id="nav-home" class="px-3 py-2 rounded-md text-sm font-medium text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700">Import CSV</button>
                        <button onclick="showView('database')" id="nav-db" class="px-3 py-2 rounded-md text-sm font-medium text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700">BDD</button>
                        <button onclick="showView('validation')" id="nav-val" class="px-3 py-2 rounded-md text-sm font-medium text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700">Inv. Tournant</button>
                        <button onclick="showView('settings')" id="nav-set" class="px-3 py-2 rounded-md text-sm font-medium text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center"><i data-lucide="settings" class="h-4 w-4 mr-1"></i> Config</button>
                    </div>
                    <button onclick="showView('operator')" id="nav-audit" class="px-3 py-2 rounded-md text-sm font-medium text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center"><i data-lucide="clipboard-list" class="h-4 w-4 mr-1"></i> Audit</button>
                </nav>
                <div class="flex items-center space-x-3">
                    <div class="text-right"><p class="text-xs font-semibold" id="userDisplayName">User</p><p class="text-[10px] text-gray-500" id="userRoleDisplay">Role</p></div>
                    <button onclick="toggleTheme()" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700" title="Thème"><i id="theme-icon" data-lucide="moon" class="h-5 w-5"></i></button>
                    <button onclick="logout()" class="p-2 rounded-full text-red-500 hover:bg-red-50 dark:hover:bg-gray-700"><i data-lucide="log-out" class="h-5 w-5"></i></button>
                </div>
            </div>
        </header>

        <main class="w-[98%] mx-auto py-6 space-y-6">
            <!-- VUES -->
            <!-- 1. OPERATEUR -->
            <div id="operatorArea" class="hidden space-y-6 fade-in">
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <div><h2 class="text-lg font-bold flex items-center"><i data-lucide="list-todo" class="h-5 w-5 mr-2 text-indigo-600"></i>Ma File d'Attente</h2><p class="text-sm text-gray-500 dark:text-gray-400" id="queueInfo">Chargement...</p></div>
                    <div class="flex gap-2"><button onclick="openSpotCheckModal()" class="p-3 bg-indigo-100 hover:bg-indigo-200 dark:bg-indigo-900/50 dark:hover:bg-indigo-900 rounded-full text-indigo-700 dark:text-indigo-300" title="Recherche / Ajout Spontané"><i data-lucide="search" class="h-6 w-6"></i></button><button onclick="loadOperatorTasks()" class="p-3 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-full"><i data-lucide="refresh-cw" class="h-6 w-6 text-gray-600 dark:text-gray-200"></i></button></div>
                </div>
                <div id="taskList" class="space-y-4"></div>
                <div id="emptyState" class="hidden text-center py-10"><h3 class="text-lg font-medium dark:text-white">Tout est à jour !</h3></div>
            </div>

            <!-- 2. ADMIN VALIDATION -->
            <div id="adminValidationArea" class="hidden space-y-6 fade-in">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold flex items-center"><i data-lucide="check-circle" class="h-6 w-6 mr-2 text-indigo-600"></i> Inventaire Tournant<div class="ml-3 flex items-center opacity-0 transition-opacity duration-500" id="live-sync-indicator" title="Synchronisation active"><span class="relative flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span></span></div></h2>
                        <div class="flex items-center gap-2"><span id="last-update-time" class="text-xs text-gray-400"></span><button onclick="refreshCurrentTab()" class="text-sm text-gray-500 hover:text-indigo-600 dark:text-gray-400 dark:hover:text-indigo-400"><i data-lucide="refresh-cw" class="h-4 w-4"></i></button></div>
                    </div>
                    <div class="flex border-b border-gray-200 dark:border-gray-700 mb-6"><button onclick="switchInvTab('validation')" id="tab-btn-validation" class="tab-btn active">Validation</button><button onclick="switchInvTab('encours')" id="tab-btn-encours" class="tab-btn">En Cours / Listes</button><button onclick="switchInvTab('history')" id="tab-btn-history" class="tab-btn">Historique</button></div>
                    <div id="tab-content-validation" class="block">
                        <div class="mb-4 flex space-x-2"><button onclick="validateConforme()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md text-sm font-medium flex items-center shadow"><i data-lucide="check-check" class="h-4 w-4 mr-2"></i> Valider conformes</button></div>
                        <div class="overflow-x-auto"><table class="min-w-full text-sm divide-y divide-gray-200 dark:divide-gray-700"><thead class="bg-gray-50 dark:bg-gray-700"><tr><th class="px-4 py-3 text-left w-2/3">Article / Zone</th><th class="px-4 py-3 text-center w-1/6">Données</th><th class="px-4 py-3 text-right w-1/6">Actions</th></tr></thead><tbody id="validationTableBody" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody></table></div>
                    </div>
                    <div id="tab-content-encours" class="hidden">
                         <div class="mb-4 flex space-x-2 justify-between items-center"><div class="text-sm text-gray-500">Liste des comptages en attente ou assignés.</div><div class="flex gap-2"><button onclick="openAddArticleModal()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md text-sm font-medium flex items-center shadow"><i data-lucide="plus" class="h-4 w-4 mr-2"></i> Ajouter Article</button><button onclick="openResetModal()" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md text-xs font-bold" title="Régénérer la liste"><i data-lucide="refresh-ccw" class="w-3 h-3 mr-1 inline"></i>Reset & Générer</button></div></div>
                        <div class="overflow-x-auto"><table class="min-w-full text-sm divide-y divide-gray-200 dark:divide-gray-700"><thead class="bg-gray-50 dark:bg-gray-700"><tr><th class="px-3 py-3 text-left">Article</th><th class="px-3 py-3 text-left">Emplacement</th><th class="px-3 py-3 text-center">Statut / Assigné</th><th class="px-3 py-3 text-right">Actions</th></tr></thead><tbody id="todoTableBody" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody></table></div>
                    </div>
                    <div id="tab-content-history" class="hidden">
                        <div class="overflow-x-auto"><table class="min-w-full text-sm divide-y divide-gray-200 dark:divide-gray-700"><thead class="bg-gray-50 dark:bg-gray-700"><tr><th class="px-3 py-3 text-left">Date</th><th class="px-3 py-3 text-left">Opérateur</th><th class="px-3 py-3 text-left">Emplacement</th><th class="px-3 py-3 text-left">Article</th><th class="px-3 py-3 text-center">Ecart</th></tr></thead><tbody id="historyTableBody" class="divide-y divide-gray-200 dark:divide-gray-700 text-sm"></tbody></table></div>
                    </div>
                </div>
            </div>

            <!-- VUE 3 : BDD -->
            <div id="databaseArea" class="hidden">
                <div class="bg-white dark:bg-gray-800 p-4 rounded shadow-lg h-[85vh] flex flex-col">
                    <div class="flex justify-between items-center mb-4 shrink-0">
                        <div class="flex items-center gap-4">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white">BDD</h2>
                            <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full font-medium hidden" id="badge-active-count">Actifs: 0</span>
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full font-medium hidden" id="badge-last-import">Import: -</span>
                        </div>
                        <div class="flex space-x-2"><input type="text" id="dbSearch" placeholder="Chercher ref/nom..." onkeyup="filterDb()" class="border p-1 rounded text-sm w-64 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white"><button onclick="forceReloadDb()" class="btn-std btn-action"><i data-lucide="refresh-cw" class="w-3 h-3 mr-1"></i> Force Reload</button></div>
                    </div>
                    <div class="flex flex-wrap gap-3 mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded border border-gray-200 dark:border-gray-600 items-center">
                        <div class="flex items-center gap-1"><span class="text-xs font-bold text-gray-500 dark:text-gray-300 mr-1 uppercase">Statut :</span><button onclick="toggleStatusFilter('Actif')" class="btn-std active" id="btn-filter-actif">Actifs</button><button onclick="toggleStatusFilter('Inactif')" class="btn-std inactive" id="btn-filter-inactif">Inactifs</button></div>
                        <div class="w-px h-5 bg-gray-300 dark:bg-gray-500 mx-2"></div>
                        <div class="flex items-center gap-1"><span class="text-xs font-bold text-gray-500 dark:text-gray-300 mr-1 uppercase">Afficher :</span><button onclick="toggleColumnGroup('col-f')" class="btn-std inactive" id="btn-col-f">Franklin</button><button onclick="toggleColumnGroup('col-g')" class="btn-std inactive" id="btn-col-g">Georges</button><button onclick="toggleColumnGroup('col-a')" class="btn-std inactive" id="btn-col-a">Abraham</button><button onclick="toggleColumnGroup('col-tech')" class="btn-std inactive" id="btn-col-tech">Dims/Poids</button></div>
                    </div>
                    <div class="overflow-auto flex-1 border rounded bg-white dark:bg-gray-900 dark:border-gray-700 relative">
                        <table class="min-w-full text-xs divide-y divide-gray-200 dark:divide-gray-700 table-compact">
                            <thead class="bg-gray-100 dark:bg-gray-700 sticky-header">
                                <tr>
                                    <th class="text-left font-bold w-16">Statut</th><th class="text-left font-bold w-16">Tags</th><th class="text-left font-bold w-24">Ref</th><th class="text-left font-bold w-64">Nom</th><th class="text-left font-bold w-32">Fournisseur</th>
                                    <th class="col-f hidden-col text-center font-bold text-f bg-f-soft border-l border-f">F-Rack</th><th class="col-f hidden-col text-center font-bold text-f bg-f-soft">F-Row</th><th class="col-f hidden-col text-center font-bold text-f bg-f-soft">F-Case</th><th class="col-f hidden-col text-center font-bold text-f bg-f-soft">F-Sur</th>
                                    <th class="col-g hidden-col text-center font-bold text-g bg-g-soft border-l border-g">G-Rack</th><th class="col-g hidden-col text-center font-bold text-g bg-g-soft">G-Row</th><th class="col-g hidden-col text-center font-bold text-g bg-g-soft">G-Case</th><th class="col-g hidden-col text-center font-bold text-g bg-g-soft">G-Sur</th>
                                    <th class="col-a hidden-col text-center font-bold text-a bg-a-soft border-l border-a">A-Rack</th><th class="col-a hidden-col text-center font-bold text-a bg-a-soft">A-Row</th><th class="col-a hidden-col text-center font-bold text-a bg-a-soft">A-Case</th><th class="col-a hidden-col text-center font-bold text-a bg-a-soft">A-Sur</th>
                                    <th class="col-tech hidden-col text-center border-l">Cote 1</th><th class="col-tech hidden-col text-center">Cote 2</th><th class="col-tech hidden-col text-center">Cote 3</th><th class="col-tech hidden-col text-center">Poids</th>
                                    <th class="text-right font-bold border-l">Stock</th><th class="text-right border-l">Ajouté</th><th class="text-right">Modifié</th><th class="text-right">Vu le</th><th class="text-right text-indigo-600 font-medium">Inv. le</th><th class="col-del hidden-col text-right text-red-600 border-l">Supprimé</th>
                                </tr>
                            </thead>
                            <tbody id="dbTableBody" class="divide-y divide-gray-100 dark:divide-gray-700"></tbody>
                        </table>
                        <div id="dbLoader" class="hidden absolute inset-0 bg-white/80 dark:bg-gray-900/80 flex items-center justify-center"><div class="loader"></div></div>
                        <div id="dbSentinel" class="h-4 w-full"></div>
                    </div>
                    <div class="text-xs text-gray-400 mt-1 flex justify-between"><span>Double-cliquez sur "Tag" pour modifier.</span><span id="dbCountDisplay">0 articles affichés</span></div>
                </div>
            </div>

            <!-- VUE 4 : PARAMETRES -->
            <div id="settingsArea" class="hidden space-y-6 fade-in">
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold mb-4 flex items-center"><i data-lucide="sliders" class="h-6 w-6 mr-2 text-indigo-600"></i>Inv. tournant</h2>
                    <div class="flex flex-col space-y-4">
                        <div class="flex items-center space-x-4">
                            <div><label class="block text-xs font-bold mb-1 dark:text-gray-300">Taille des lots auto (Mensuel)</label><input type="number" id="settingBatchSize" class="border p-2 rounded w-24 dark:bg-gray-600 dark:border-gray-500 dark:text-white" onchange="saveParam('AUTO_BATCH_SIZE', this.value)"></div>
                            <div class="pt-5 flex items-center space-x-3"><button id="btn-trigger-action" onclick="promptToggleTrigger()" class="text-xs px-4 py-2 rounded font-bold shadow-sm transition-colors flex items-center">Chargement...</button><span id="triggerStatus" class="text-xs font-medium"></span></div>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 italic bg-gray-50 dark:bg-gray-700/50 p-2 rounded border border-gray-100 dark:border-gray-700"><i data-lucide="info" class="w-3 h-3 inline-block mr-1"></i>Génère automatiquement une liste d'inventaire le 1er de chaque mois à 06h00 selon les règles de fréquence.</p>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md"><h2 class="text-xl font-bold mb-4 flex items-center"><i data-lucide="users" class="h-6 w-6 mr-2 text-indigo-600"></i>Utilisateurs</h2><div class="mb-4 bg-gray-50 dark:bg-gray-700 p-4 rounded-lg flex items-end gap-2"><div><label class="text-xs font-bold dark:text-gray-300">Nom</label><input id="newNom" class="w-full p-2 border rounded dark:bg-gray-600 dark:border-gray-500 dark:text-white"></div><div><label class="text-xs font-bold dark:text-gray-300">Prénom</label><input id="newPrenom" class="w-full p-2 border rounded dark:bg-gray-600 dark:border-gray-500 dark:text-white"></div><div><label class="text-xs font-bold dark:text-gray-300">PIN</label><input id="newPin" type="number" class="w-20 p-2 border rounded dark:bg-gray-600 dark:border-gray-500 dark:text-white"></div><div><label class="text-xs font-bold dark:text-gray-300">Rôle</label><select id="newRole" class="w-full p-2 border rounded dark:bg-gray-600 dark:border-gray-500 dark:text-white"><option>Opérateur</option><option>Admin</option></select></div><div><label class="text-xs font-bold dark:text-gray-300">Zone</label><select id="newZone" class="w-full p-2 border rounded dark:bg-gray-600 dark:border-gray-500 dark:text-white"><option value="F">Franklin</option><option value="G">George</option><option value="A">Abraham</option></select></div><button onclick="addUser()" class="p-2 bg-indigo-600 text-white rounded"><i data-lucide="plus" class="h-5 w-5"></i></button></div><table class="min-w-full text-sm"><thead class="bg-gray-100 dark:bg-gray-700"><tr><th class="p-2 text-left">Nom</th><th class="p-2 text-left">PIN</th><th class="p-2 text-left">Rôle</th><th class="p-2 text-left">Zone</th><th class="p-2"></th></tr></thead><tbody id="usersTableBody"></tbody></table></div><div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md mt-6"><h2 class="text-xl font-bold mb-4 flex items-center"><i data-lucide="tags" class="h-6 w-6 mr-2 text-indigo-600"></i>Règles de Fréquence</h2><table class="min-w-full text-sm"><thead class="bg-gray-100 dark:bg-gray-700"><tr><th class="p-2 text-left">Tag</th><th class="p-2 text-left">Fréquence (Jours)</th><th class="p-2 text-left">Couleur</th><th class="p-2">Action</th></tr></thead><tbody id="tagsTableBody"></tbody></table></div>
            </div>

            <!-- VUE 5 : IMPORT -->
            <div id="homeArea" class="hidden">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 h-[85vh] flex flex-col overflow-hidden">
                    <div class="p-6 pb-0 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800">
                        <h2 class="text-2xl font-bold mb-4 dark:text-white flex items-center"><i data-lucide="database-backup" class="w-8 h-8 mr-3 text-indigo-600"></i>Gestion des Imports CSV</h2>
                        <div class="flex space-x-6"><button onclick="switchImportTab('new')" id="btn-import-new" class="pb-3 border-b-2 font-medium transition-colors text-indigo-600 border-indigo-600">Nouvel Import</button><button onclick="switchImportTab('history')" id="btn-import-history" class="pb-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors">Historique & Feuilles</button></div>
                    </div>
                    <div id="tab-import-new" class="flex-1 p-8 overflow-y-auto">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 h-full">
                            <div class="flex flex-col justify-center items-center">
                                <div class="w-full max-w-sm space-y-6">
                                    <div class="text-left"><label class="block text-sm font-semibold mb-2 text-gray-700 dark:text-gray-300">Date du stock</label><input type="date" id="importDate" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-gray-700 dark:text-white transition-shadow"></div>
                                    <div class="text-left"><label class="block text-sm font-semibold mb-2 text-gray-700 dark:text-gray-300">Fichier d'export (ex: Vérif réf.csv)</label><label class="flex flex-col items-center px-4 py-8 bg-white dark:bg-gray-700 text-blue rounded-lg shadow-sm border-2 border-dashed border-gray-300 dark:border-gray-500 cursor-pointer hover:border-indigo-50 dark:hover:border-indigo-400 hover:bg-indigo-50 dark:hover:bg-gray-600 transition-all group"><i data-lucide="file-up" class="w-10 h-10 text-gray-400 group-hover:text-indigo-500 mb-2 transition-colors"></i><span class="text-sm font-medium text-gray-600 dark:text-gray-300 group-hover:text-indigo-600 dark:group-hover:text-indigo-300">Cliquez pour choisir un fichier</span><span class="text-xs text-gray-400 mt-1">Format .CSV uniquement</span><input type="file" id="csvFile" class="hidden" accept=".csv" /></label></div>
                                    <button type="button" onclick="handleFileUpload()" class="w-full py-3 px-6 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-lg transform transition hover:scale-[1.02] active:scale-95 flex items-center justify-center"><i data-lucide="play" class="w-5 h-5 mr-2"></i> Lancer l'import</button>
                                </div>
                            </div>
                            <div class="flex flex-col gap-6 justify-center">
                                <div class="bg-blue-50 dark:bg-blue-900/20 p-6 rounded-xl border border-blue-100 dark:border-blue-800"><h3 class="font-bold text-blue-800 dark:text-blue-300 mb-4 flex items-center"><i data-lucide="info" class="w-5 h-5 mr-2"></i> Instructions</h3><ul class="space-y-3 text-sm text-blue-900 dark:text-blue-200"><li class="flex items-start"><span class="mr-2 text-lg leading-none">•</span> Le fichier doit être au format <strong>.csv</strong>.</li><li class="flex items-start"><span class="mr-2 text-lg leading-none">•</span> Le nom de l'export source obligatoire dans Odoo est <strong>"Vérif réf"</strong>.</li><li class="flex items-start"><span class="mr-2 text-lg leading-none">•</span> <strong class="text-red-600 dark:text-red-400">Important :</strong> Le contenu du CSV ne doit pas être modifié.</li><li class="flex items-start"><span class="mr-2 text-lg leading-none">•</span> Ne jamais supprimer de colonnes, même vides.</li><li class="flex items-start"><span class="mr-2 text-lg leading-none">•</span> Vérifiez que le fichier n'est pas ouvert dans Excel lors de l'import.</li><li class="flex items-start"><span class="mr-2 text-lg leading-none">•</span> Encodage requis : <strong>UTF-8</strong> (pour préserver les accents).</li><li class="flex items-start"><span class="mr-2 text-lg leading-none">•</span> Taille maximum recommandée : <strong>10 Mo</strong>.</li></ul></div>
                                <div class="bg-green-50 dark:bg-green-900/20 p-6 rounded-xl border border-green-100 dark:border-green-800"><h3 class="font-bold text-green-800 dark:text-green-300 mb-4 flex items-center"><i data-lucide="info" class="w-5 h-5 mr-2"></i> Informations</h3><ul class="space-y-3 text-sm text-green-900 dark:text-green-200"><li class="flex items-start"><span class="mr-2 text-lg leading-none">•</span> La colonne <strong>"Quantité en stock"</strong> met à jour le stock "Réel" pour les calculs d'écarts.</li><li class="flex items-start"><span class="mr-2 text-lg leading-none">•</span> Les <strong>inventaires tournants</strong> se baseront sur le dernier import effectué ici.</li><li class="flex items-start"><span class="mr-2 text-lg leading-none">•</span> L'import écrase les données de stock précédentes (pas de cumul).</li><li class="flex items-start"><span class="mr-2 text-lg leading-none">•</span> Une copie de sauvegarde est automatiquement créée dans l'historique.</li><li class="flex items-start"><span class="mr-2 text-lg leading-none">•</span> Le traitement peut prendre jusqu'à 30 secondes pour les gros fichiers.</li></ul></div>
                            </div>
                        </div>
                    </div>
                    <div id="tab-import-history" class="hidden flex-1 p-0 overflow-y-auto"><table class="min-w-full text-sm divide-y divide-gray-200 dark:divide-gray-700"><thead class="bg-gray-50 dark:bg-gray-700 sticky top-0 z-10 shadow-sm"><tr><th class="px-6 py-3 text-left font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Date Import</th><th class="px-6 py-3 text-left font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Nom Session</th><th class="px-6 py-3 text-left font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Nom Feuille GSheet</th><th class="px-6 py-3 text-center font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Statut Feuille</th><th class="px-6 py-3 text-right font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Action</th></tr></thead><tbody id="importHistoryBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody></table></div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALES -->
    <div id="modalAddManual" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[60]">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-96">
            <h3 class="text-lg font-bold mb-4 dark:text-white">Ajouter à la liste</h3>
            <input type="text" id="manualRefInput" placeholder="Référence Article..." class="w-full p-2 border rounded mb-2 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-indigo-500" onkeyup="searchManualAddDb()">
            <div id="manualAddSearchResults" class="max-h-40 overflow-y-auto mb-4 border-t border-gray-100 dark:border-gray-700"></div>
            <!-- SWITCH PRIORITE -->
            <div class="flex items-center justify-between mb-4 bg-gray-50 dark:bg-gray-700 p-2 rounded">
                <span class="text-sm font-bold text-gray-700 dark:text-gray-300">Priorité Haute ⚡</span>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="manualPrioToggle" class="sr-only peer">
                  <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div>
                </label>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('modalAddManual').classList.add('hidden')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">Annuler</button>
                <button onclick="confirmAddManual()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Ajouter</button>
            </div>
        </div>
    </div>
    
    <div id="modalConfirmTrigger" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[70]">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-96"><h3 id="modalTriggerTitle" class="text-lg font-bold mb-2 dark:text-white">Confirmation</h3><p id="modalTriggerDesc" class="text-sm text-gray-600 dark:text-gray-300 mb-6">...</p><div class="flex justify-end gap-3"><button onclick="closeModalTrigger()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-300 rounded transition-colors">Annuler</button><button onclick="executeToggleTrigger()" id="btnConfirmTrigger" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-colors shadow-sm font-medium">Confirmer</button></div></div>
    </div>

    <!-- INCLUSION LOGIQUE JAVASCRIPT -->
    <?!= include('JS_Core'); ?>
    <?!= include('JS_App'); ?>
    <?!= include('JS_Settings'); ?>
</body>
</html>
